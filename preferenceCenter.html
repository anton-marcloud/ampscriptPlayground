<!DOCTYPE html>
<html>
<head>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
    />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>
<body>


%%[
SET @subscriberKey = [_subscriberkey]

// PROFILE ATTRIBUTES
SET @firstName = [First Name]
SET @lastName = [Last Name]
SET @emailAddress = [Email Address]
SET @website = [Website]


// PREFERENCE ATTRIBUTES
SET @education = IIF([Education], "checked", "")
SET @energy = IIF([Energy], "checked", "")
SET @finance = IIF([Finance], "checked", "")
SET @health = IIF([Health], "checked", "")
SET @retail = IIF([Retail], "checked", "")
SET @technology = IIF([Technology], "checked", "")
SET @telecoms = IIF([Telecoms], "checked", "")
SET @transport = IIF([Transport], "checked", "")
SET @3rd party emails = IIF([3rd party emails], "checked", "")
]%%

<script runat="server" language="JavaScript">
    Platform.Load("core", "1.1.2");

    var subscriptionStatus = Subscriber.Retrieve({
        Property: "SubscriberKey",
        SimpleOperator: "equals",
        Value: Variable.GetValue("@subscriberKey")
    });

    if (subscriptionStatus[0].Status == "Active") {
        Variable.SetValue("subscriptionStatus", true);
    } else {
        Variable.SetValue("subscriptionStatus", false);
    }

    // POST VARIABLES
    var subscriberKey = Platform.Request.GetFormField('subscriberKey') || "";
    var firstName = Platform.Request.GetFormField('firstName') || "";
    var lastName = Platform.Request.GetFormField('lastName') || "";
    var email = Platform.Request.GetFormField('email') || "";
    var website = Platform.Request.GetFormField('website') || "";
    var Education = Platform.Request.GetFormField('Education') || false;
    var Energy = Platform.Request.GetFormField('Energy') || false;
    var finance = Platform.Request.GetFormField('finance') || false;
    var health = Platform.Request.GetFormField('health') || false;
    var retail = Platform.Request.GetFormField('retail') || false;
    var technology = Platform.Request.GetFormField('technology') || false;
    var telecoms = Platform.Request.GetFormField('telecoms') || false;
    var transport = Platform.Request.GetFormField('transport') || false;
    var thirdPartyEmails = Platform.Request.GetFormField('3rd party emails') || false;
    var unsubscribe = Platform.Request.GetFormField('unsubscribe') || false;
    var subscribeTo = Platform.Request.GetFormField('subscribe') || false;

    if (subscriberKey) {
        var subscriberData = {
            "Attributes": {
                "First Name": firstName,
                "Last Name": lastName,
                "Website": website,
                "Education": education,
                "Energy": energy,
                "Finance": finance,
                "Health": health,
                "Retail": retail,
                "Technology": technology,
                "Telecoms": telecoms,
                "Transport": transport,
                "3rd party emails": thirdPartyEmails
            }
        }

        if(subscribeTo) {
            subscriberData.Status = "Active";
        }

        var subObj = Subscriber.Init(subscriberKey);

        if(unsubscribe) {
            var unsubscribeSatus = subObj.Unsubscribe();
            Variable.SetValue("unsubscribeSatus", unsubscribeSatus);
        } else {
            var udpateStatus = subObj.Update(subscriberData);
            Variable.SetValue("unsubscribeSatus", (subscribeTo && udpateStatus) ? "SUBSCRIBED" : "NA");
            Variable.SetValue("udpateStatus", udpateStatus);
        }

        Variable.SetValue("formSubmitted", true);
    }
    else
    {
        Variable.SetValue("formSubmitted", false);
    }
</script>

<form method="POST">
    <input type="hidden" name="subscriberKey" value="%%=v(@subscriberkey)=%%">

    <h2>Update your profile:</h2>
    <label>First Name: </label><input type="text" name="firstName" value="%%=v(@firstName)=%%"><br>
    <label>Last Name: </label><input type="text" name="lastName" value="%%=v(@lastName)=%%"><br>
    <label>* Email: </label><input type="email" required name="email" value="%%=v(@emailAddress)=%%"><br>
    <label>Website: </label><input type="url" name="website" value="%%=v(@website)=%%"><br>

    <h2>Update your subscriptions:</h2>
    <input name="Education" value="true" type="checkbox" %%=v(@Education)=%%>

    <label>:Education</label>
    <input name="Energyr" value="true" type="checkbox" %%=v(@Energy)=%%>

    <label>:Energy </label>
    <input name="Finance " value="true" type="checkbox" %%=v(@Finance)=%%>

    <label>:Finance</label>
    <input name="Health" value="true" type="checkbox" %%=v(@Health)=%%>

    <label>:Health</label>
    <input name="Retail" value="true" type="checkbox" %%=v(@Retail)=%%>

    <label>:Retail</label>
    <input name="Technology" value="true" type="checkbox" %%=v(@Technology)=%%>

    <label>:Technology</label>
    <input name="Telecoms" value="true" type="checkbox" %%=v(@Telecoms)=%%>

    <label>:Telecoms</label>
    <input name="Transport" value="true" type="checkbox" %%=v(@Transport)=%%>

    <label>:Transport</label>
    <input name="3rd party emails" value="true" type="checkbox" %%=v(@3rd party emails)=%%>

    <label>:3rd party emails</label>
    <input name="Unsubscribe from all marketing lists" value="true" type="checkbox" %%=v(@Unsubscribe [email
           address] from all marketing lists)=%%>

    <!--    <label>:Unsubscribe%%=v(@emailAddress)=%% from all marketing lists -->

    <label>%%=IIF(@subscriptionStatus, "Unsubscribe from all", "Resubscribe")=%%</label>
    <input name='%%=IIF(@subscriptionStatus, "unsubscribe", "subscribe")=%%' value="true" type="checkbox"><br>
    (You are %%=IIF(@subscriptionStatus, "subscribed to", "unsubscribed from")=%% us!)

    <br/> <br/>

    <input type="submit" value="Update">

</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.3.5/dist/sweetalert2.all.min.js"></script>

%%[ IF @formSubmitted AND @udpateStatus == "OK" AND @unsubscribeSatus == "NA" THEN ]%%
<script>
    Swal.fire("Updated!", "Your preferences are updated successfully", "success").then(() => {
        location.href = location.href;
    });
</script>
%%[ ELSEIF @formSubmitted AND @udpateStatus != "OK" AND @unsubscribeSatus == "NA" THEN ]%%
<script>
    Swal.fire("Not Updated!", "Something went wrong while updating your preferences", "error").then(() => {
        location.href = location.href;
    });
</script>
%%[ ELSEIF @formSubmitted AND @unsubscribeSatus == "OK" THEN ]%%
<script>
    Swal.fire("Unsubscribed!", "Sorry to see you go away!", "info").then(() => {
        location.href = location.href;
    });
</script>
%%[ ELSEIF @formSubmitted AND @unsubscribeSatus == "SUBSCRIBED" THEN ]%%
<script>
    Swal.fire("Subscribed!", "Happy to see you again!<br/>We make sure we don't spam you!!", "success").then(() => {
        location.href = location.href;
    });
</script>
%%[ ELSE ]%%
%%[ ENDIF ]%%


</body>
</html>